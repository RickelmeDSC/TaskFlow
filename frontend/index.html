<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow - Gerenciador de Tarefas</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üìã TaskFlow</h1>
            <p>Seu gerenciador de tarefas simples e eficiente</p>
        </header>

        <div class="app-container">
            <div class="task-form-section">
                <h2>Nova Tarefa</h2>
                <form id="taskForm" class="task-form">
                    <div class="form-group">
                        <label for="title">T√≠tulo *</label>
                        <input type="text" id="title" name="title" required placeholder="Digite o t√≠tulo da tarefa">
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Descri√ß√£o</label>
                        <textarea id="description" name="description" rows="3" placeholder="Descreva a tarefa (opcional)"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="priority">Prioridade</label>
                            <select id="priority" name="priority">
                                <option value="baixa">Baixa</option>
                                <option value="media" selected>M√©dia</option>
                                <option value="alta">Alta</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="category">Categoria</label>
                            <select id="category" name="category">
                                <option value="lazer">Lazer</option>
                                <option value="estudo">Estudo</option>
                                <option value="trabalho">Trabalho</option>
                                <option value="saude">Sa√∫de</option>
                                <option value="casa">Casa</option>
                                <option value="compras">Compras</option>
                                <option value="outros" selected>Outros</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="due_date">Data de Vencimento</label>
                        <input type="date" id="due_date" name="due_date">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Adicionar Tarefa</button>
                </form>
            </div>

            <div class="tasks-section">
                <h2>Minhas Tarefas</h2>
                
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="üîç Buscar tarefas..." class="search-input">
                </div>

                <div class="stats">
                    <div class="stat-item">
                        <span class="stat-number">0</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">0</span>
                        <span class="stat-label">Pendentes</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">0</span>
                        <span class="stat-label">Conclu√≠das</span>
                    </div>
                </div>

                <div class="filters">
                    <button class="filter-btn active" data-filter="all">Todas</button>
                    <button class="filter-btn" data-filter="pendente">Pendentes</button>
                    <button class="filter-btn" data-filter="concluida">Conclu√≠das</button>
                </div>
                
                <div id="tasksList" class="tasks-list">
                    <div class="loading">Carregando tarefas...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>‚úèÔ∏è Editar Tarefa</h2>
            <form id="editTaskForm">
                <input type="hidden" id="edit_id" name="id">
                
                <div class="form-group">
                    <label for="edit_title">T√≠tulo *</label>
                    <input type="text" id="edit_title" name="title" required placeholder="Digite o t√≠tulo da tarefa">
                </div>
                
                <div class="form-group">
                    <label for="edit_description">Descri√ß√£o</label>
                    <textarea id="edit_description" name="description" rows="3" placeholder="Descreva a tarefa (opcional)"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_status">Status</label>
                        <select id="edit_status" name="status">
                            <option value="pendente">Pendente</option>
                            <option value="concluida">Conclu√≠da</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_priority">Prioridade</label>
                        <select id="edit_priority" name="priority">
                            <option value="baixa">Baixa</option>
                            <option value="media">M√©dia</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_category">Categoria</label>
                        <select id="edit_category" name="category">
                            <option value="lazer">Lazer</option>
                            <option value="estudo">Estudo</option>
                            <option value="trabalho">Trabalho</option>
                            <option value="saude">Sa√∫de</option>
                            <option value="casa">Casa</option>
                            <option value="compras">Compras</option>
                            <option value="outros">Outros</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit_due_date">Data de Vencimento</label>
                    <input type="date" id="edit_due_date" name="due_date">
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
                    <button type="button" class="btn btn-secondary" id="cancelEdit">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        let currentFilter = 'all';
        let tasks = [];

        console.log('üöÄ TaskFlow Inicializado!');

        function showMessage(message, type = 'error') {
            const existingMessages = document.querySelectorAll('.success, .error');
            existingMessages.forEach(msg => msg.remove());
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.innerHTML = type === 'success' ? `‚úÖ ${message}` : `‚ùå ${message}`;
            
            const container = document.querySelector('.container');
            container.insertBefore(messageDiv, container.firstChild);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        async function apiRequest(endpoint, options = {}) {
            try {
                console.log(`üåê Fazendo requisi√ß√£o: ${endpoint}`);
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('‚ùå Erro na requisi√ß√£o:', error);
                showMessage('Erro de conex√£o com o servidor');
                throw error;
            }
        }

        function setupFilters() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    displayTasks(tasks);
                });
            });
        }

        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                filterTasksBySearch(term);
            });
        }

        function filterTasksBySearch(searchTerm) {
            if (!searchTerm) {
                displayTasks(tasks);
                return;
            }
            
            const filteredTasks = tasks.filter(task => 
                task.title.toLowerCase().includes(searchTerm) ||
                (task.description && task.description.toLowerCase().includes(searchTerm)) ||
                task.category.toLowerCase().includes(searchTerm)
            );
            
            displayTasks(filteredTasks);
        }

        function updateStats() {
            const total = tasks.length;
            const pending = tasks.filter(t => t.status === 'pendente').length;
            const completed = tasks.filter(t => t.status === 'concluida').length;
            
            const statNumbers = document.querySelectorAll('.stat-number');
            if (statNumbers.length === 3) {
                statNumbers[0].textContent = total;
                statNumbers[1].textContent = pending;
                statNumbers[2].textContent = completed;
            }
        }

        async function loadTasks() {
            const tasksList = document.getElementById('tasksList');
            
            try {
                tasksList.innerHTML = '<div class="loading">üîÑ Carregando tarefas...</div>';
                
                if (!localStorage.getItem('tasks')) {
                    const sampleTasks = [
                        {
                            id: 1,
                            title: 'Estudar JavaScript',
                            description: 'Revisar conceitos de ES6+ e async/await',
                            priority: 'alta',
                            category: 'estudo',
                            status: 'pendente',
                            due_date: '2024-12-15',
                            created_at: '2024-11-11'
                        },
                        {
                            id: 2,
                            title: 'Fazer compras no mercado',
                            description: 'Comprar alimentos para a semana toda',
                            priority: 'media',
                            category: 'compras',
                            status: 'concluida',
                            due_date: '2024-11-20',
                            created_at: '2024-11-10'
                        },
                        {
                            id: 3,
                            title: 'Academia',
                            description: 'Treino de pernas e cardio',
                            priority: 'baixa',
                            category: 'saude',
                            status: 'pendente',
                            due_date: '2024-11-12',
                            created_at: '2024-11-11'
                        }
                    ];
                    localStorage.setItem('tasks', JSON.stringify(sampleTasks));
                }
                
                const tasksData = JSON.parse(localStorage.getItem('tasks')) || [];
                tasks = tasksData;
                
                displayTasks(tasks);
                updateStats();
                
                console.log(`‚úÖ ${tasks.length} tarefas carregadas`);
            } catch (error) {
                tasksList.innerHTML = '<div class="error">‚ùå Erro ao carregar tarefas.</div>';
                console.error('Erro ao carregar tarefas:', error);
            }
        }

        function displayTasks(tasksToDisplay = tasks) {
            const tasksList = document.getElementById('tasksList');
            
            if (tasksToDisplay.length === 0) {
                tasksList.innerHTML = '<div class="empty-state">üìù Nenhuma tarefa encontrada. Adicione sua primeira tarefa!</div>';
                return;
            }
            
            const filteredTasks = tasksToDisplay.filter(task => {
                if (currentFilter === 'all') return true;
                return task.status === currentFilter;
            });
            
            if (filteredTasks.length === 0) {
                tasksList.innerHTML = `<div class="empty-state">üìù Nenhuma tarefa ${currentFilter} encontrada.</div>`;
                return;
            }
            
            tasksList.innerHTML = filteredTasks.map(task => {
                const isOverdue = isTaskOverdue(task);
                const taskClass = isOverdue ? 'task-item task-overdue' : 'task-item';
                
                return `
                    <div class="${taskClass}" data-task-id="${task.id}">
                        <div class="task-header">
                            <div class="task-title">
                                ${escapeHtml(task.title)}
                                ${isTaskNew(task) ? '<span class="new-badge">NOVO</span>' : ''}
                            </div>
                            <div class="task-badges">
                                <span class="task-priority priority-${task.priority}">
                                    ${getPriorityText(task.priority)}
                                </span>
                                <span class="category-badge category-${task.category}">
                                    ${getCategoryText(task.category)}
                                </span>
                                <span class="status-indicator status-${task.status}"></span>
                            </div>
                        </div>
                        
                        ${task.description ? `
                            <div class="task-description">${escapeHtml(task.description)}</div>
                        ` : ''}
                        
                        <div class="task-meta">
                            <div class="task-info">
                                <span class="task-status">
                                    <span class="status-indicator status-${task.status}"></span>
                                    ${getStatusText(task.status)}
                                </span>
                                ${task.due_date ? `
                                    <span class="task-due-date ${isOverdue ? 'overdue' : ''}">
                                        üìÖ ${formatDate(task.due_date)} ${isOverdue ? '(VENCIDA)' : ''}
                                    </span>
                                ` : ''}
                                ${task.created_at ? `
                                    <span class="task-created">
                                        üóìÔ∏è ${formatDate(task.created_at)}
                                    </span>
                                ` : ''}
                            </div>
                            
                            <div class="task-actions">
                                <button class="btn btn-success btn-sm" onclick="updateTaskStatus(${task.id})">
                                    ${task.status === 'concluida' ? '‚Ü∂ Reabrir' : '‚úì Concluir'}
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="editTask(${task.id})">‚úèÔ∏è Editar</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteTask(${task.id})">üóëÔ∏è Excluir</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('taskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const taskData = {
                id: Date.now(),
                title: formData.get('title').trim(),
                description: formData.get('description').trim(),
                priority: formData.get('priority'),
                category: formData.get('category'),
                status: 'pendente',
                due_date: formData.get('due_date') || null,
                created_at: new Date().toISOString().split('T')[0]
            };
            
            if (!taskData.title) {
                showMessage('Por favor, insira um t√≠tulo para a tarefa.');
                return;
            }
            
            try {
                tasks.push(taskData);
                localStorage.setItem('tasks', JSON.stringify(tasks));
                
                this.reset();
                document.getElementById('priority').value = 'media';
                document.getElementById('category').value = 'outros';
                
                displayTasks(tasks);
                updateStats();
                showMessage('Tarefa criada com sucesso!', 'success');
                
            } catch (error) {
                showMessage('Erro ao criar tarefa.');
                console.error('Erro ao criar tarefa:', error);
            }
        });

        async function updateTaskStatus(taskId) {
            try {
                const taskIndex = tasks.findIndex(t => t.id == taskId);
                if (taskIndex !== -1) {
                    tasks[taskIndex].status = tasks[taskIndex].status === 'concluida' ? 'pendente' : 'concluida';
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                    displayTasks(tasks);
                    updateStats();
                    showMessage('Status atualizado com sucesso!', 'success');
                }
            } catch (error) {
                showMessage('Erro ao atualizar status.');
                console.error('Erro:', error);
            }
        }

        async function editTask(taskId) {
            const task = tasks.find(t => t.id == taskId);
            if (task) {
                document.getElementById('edit_id').value = task.id;
                document.getElementById('edit_title').value = task.title;
                document.getElementById('edit_description').value = task.description || '';
                document.getElementById('edit_status').value = task.status;
                document.getElementById('edit_priority').value = task.priority;
                document.getElementById('edit_category').value = task.category;
                document.getElementById('edit_due_date').value = task.due_date || '';
                
                document.getElementById('editModal').style.display = 'block';
            }
        }

        document.getElementById('editTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const taskId = parseInt(formData.get('id'));
            const taskData = {
                title: formData.get('title').trim(),
                description: formData.get('description').trim(),
                status: formData.get('status'),
                priority: formData.get('priority'),
                category: formData.get('category'),
                due_date: formData.get('due_date') || null
            };
            
            if (!taskData.title) {
                showMessage('Por favor, insira um t√≠tulo para a tarefa.');
                return;
            }
            
            try {
                const taskIndex = tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    tasks[taskIndex] = { ...tasks[taskIndex], ...taskData };
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                    
                    closeEditModal();
                    displayTasks(tasks);
                    updateStats();
                    showMessage('Tarefa atualizada com sucesso!', 'success');
                }
            } catch (error) {
                showMessage('Erro ao atualizar tarefa.');
                console.error('Erro:', error);
            }
        });

        async function deleteTask(taskId) {
            if (!confirm('Tem certeza que deseja excluir esta tarefa? Esta a√ß√£o n√£o pode ser desfeita.')) return;
            
            try {
                tasks = tasks.filter(t => t.id != taskId);
                localStorage.setItem('tasks', JSON.stringify(tasks));
                displayTasks(tasks);
                updateStats();
                showMessage('Tarefa exclu√≠da com sucesso!', 'success');
            } catch (error) {
                showMessage('Erro ao excluir tarefa.');
                console.error('Erro:', error);
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        document.querySelector('.close').addEventListener('click', closeEditModal);
        document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
        window.addEventListener('click', function(e) {
            if (e.target === document.getElementById('editModal')) {
                closeEditModal();
            }
        });

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function getStatusText(status) {
            const statusMap = { 'pendente': 'Pendente', 'concluida': 'Conclu√≠da' };
            return statusMap[status] || status;
        }

        function getPriorityText(priority) {
            const priorityMap = { 'baixa': 'Baixa', 'media': 'M√©dia', 'alta': 'Alta' };
            return priorityMap[priority] || priority;
        }

        function getCategoryText(category) {
            const categoryMap = {
                'lazer': 'Lazer', 'estudo': 'Estudo', 'trabalho': 'Trabalho',
                'saude': 'Sa√∫de', 'casa': 'Casa', 'compras': 'Compras', 'outros': 'Outros'
            };
            return categoryMap[category] || category;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR');
            } catch (error) {
                return dateString;
            }
        }

        function isTaskOverdue(task) {
            if (!task.due_date || task.status === 'concluida') return false;
            
            const today = new Date();
            const dueDate = new Date(task.due_date);
            today.setHours(0, 0, 0, 0);
            dueDate.setHours(0, 0, 0, 0);
            
            return dueDate < today;
        }

        function isTaskNew(task) {
            if (!task.created_at) return false;
            
            const created = new Date(task.created_at);
            const now = new Date();
            const diffTime = Math.abs(now - created);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays <= 1;
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìç Inicializando TaskFlow...');
            setupFilters();
            setupSearch();
            loadTasks();
        });

        window.loadTasks = loadTasks;
        window.updateTaskStatus = updateTaskStatus;
        window.editTask = editTask;
        window.deleteTask = deleteTask;
        window.closeEditModal = closeEditModal;
    </script>
</body>
</html>